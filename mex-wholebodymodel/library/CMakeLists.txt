set(SOURCES src/mexmain.cpp
            src/componentmanager.cpp
            src/modelstate.cpp
            src/modelcomponent.cpp
            src/modelcentroidalmomentum.cpp
            src/modelcoriolisbiasforces.cpp
            src/modeldjdq.cpp
            src/modelforwardkinematics.cpp
            src/modelgeneralizedbiasforces.cpp
            src/modelgetfloatingbasestate.cpp
            src/modelgetstate.cpp
            src/modelgravitybiasforces.cpp
            src/modelinitialize.cpp
            src/modelinitializeurdf.cpp
            src/modelinversedynamics.cpp
            src/modeljacobian.cpp
            src/modeljointlimits.cpp
            src/modelmassmatrix.cpp
            src/modelsetworldframe.cpp
            src/modeltransformationmatrix.cpp
            src/modelupdatestate.cpp
            src/modelvisualizetrajectory.cpp
)
            
set(HEADERS include/componentmanager.h
            include/modelstate.h
            include/modelcomponent.h
            include/mexwholebodymodelsettings.h
            include/modelcentroidalmomentum.h
            include/modelcoriolisbiasforces.h
            include/modeldjdq.h
            include/modelforwardkinematics.h
            include/modelgeneralizedbiasforces.h
            include/modelgetfloatingbasestate.h
            include/modelgetstate.h
            include/modelgravitybiasforces.h
            include/modelinitialize.h
            include/modelinitializeurdf.h
            include/modelinversedynamics.h
            include/modeljacobian.h
            include/modeljointlimits.h
            include/modelmassmatrix.h
            include/modelsetworldframe.h
            include/modeltransformationmatrix.h
            include/modelupdatestate.h
            include/modelvisualizetrajectory.h
)

source_group("Source Files" FILES ${SOURCES})
source_group("Headers Files" FILES ${HEADERS})

#Some additional options
include(iCubHelpers)
include(iCubOptions)

SET(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} ${ICUB_LINK_FLAGS}")

#Include directories
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include
                    ${wholeBodyInterface_INCLUDE_DIRS}
                    ${wholeBodyInterfaceIcub_INCLUDE_DIRS}
                    ${iDynTree_INCLUDE_DIRS}
                    ${paramHelp_INCLUDE_DIRS}
                    ${skinDynLib_INCLUDE_DIRS}
                    ${ctrlLib_INCLUDE_DIRS})

include_directories(${Matlab_INCLUDE_DIRS})
include_directories(${YARP_INCLUDE_DIRS})
include_directories(${ICUB_INCLUDE_DIRS})

#Specify preprocessor flag for MATLAB MEX FILES Compilation.
add_definitions(-DMATLAB_MEX_FILE)

#MATLAB_MEXFILE_EXT is generated by FindMatlab.cmake
set(MEXFILE_SUFFIX ${Matlab_MEX_EXTENSION})

link_directories(${CMAKE_BINARY_DIR})

#Adding files used for the generation of the dynamic library
add_library(${PROJECT_NAME} SHARED ${SOURCES} ${HEADERS})

# set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fpermissive")
if(${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
    if(${CMAKE_CXX_COMPILER_ID} MATCHES "Clang")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11")
    endif()
endif()

#Removing default dynamic library extensions (.dll for Windows, .so for UNIX) and prefixes (lib) otherwise automatically prepended to the mex file.
set_target_properties(${PROJECT_NAME} PROPERTIES SUFFIX .${MEXFILE_SUFFIX})
set_target_properties(${PROJECT_NAME} PROPERTIES PREFIX "")

#In the following specific flags will be set to ensure compliance with the default settings of Matlab's mex compiler
if(WIN32)
        if("${MATLAB_ARCH}" STREQUAL "32")
                message("Flags have been passed to compiler for Matlab 32bits on a Windows computer")
        elseif()
                message("Flags have been passed to compiler for Matlab 64bits on a Windows computer")
        endif()
                if(MSVC)
                        #Setting Compiler Flags
                        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /Z7 /nologo /W3 /WX- /O2 /Oy- /D_REENTRANT /D_CRT_SECURE_NO_DEPRECATE /D_SCL_SECURE_NO_DEPRECATE /D_SECURE_SCL=0 /DyWrite_EXPORTS /Gm- /EHs /Zp8 /GS /fp:precise /Zc:wchar_t /Zc:forScope /GR /Gd /TP /showIncludes")
                        #Setting Linker Flags
                        set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} /INCREMENTAL:NO /NOLOGO /MANIFEST /debug /MAP.mexw64.map /MACHINE:X64 /EXPORT:mexFunction")
                        if("${MATLAB_ARCH}" STREQUAL "32")
                                #Changing some flags according to system/MATLAB version (32, 64 bits)
                                set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} /MAP.mexw32.map /MACHINE:X32")
                        endif()
                elseif(MSVC)
                        message("You are not compiling using Microsoft Visual Studio, ERRORS might occur")
                endif(MSVC)
elseif(WIN32)
        message("No particular flags have been passed to compiler for Matlab 64bits on a UNIX computer")
endif(WIN32)

target_link_libraries(${PROJECT_NAME}
${wholeBodyInterface_LIBRARIES}
${yarpWholeBodyInterface_LIBRARIES}
${paramHelp_LIBRARIES}
${iDynTree_LIBRARIES}
${YARP_LIBRARIES}
${Matlab_LIBRARIES}
${skinDynLib_LIBRARIES}
${ctrlLib_LIBRARIES}
)

install(TARGETS ${PROJECT_NAME} DESTINATION ${CMAKE_INSTALL_PREFIX}/mex)
